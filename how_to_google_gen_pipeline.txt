#################################################################################

# How to build a custom docker image, and run a custom script with
# Google Genomics Pipelines
# David L Gibbs
# dgibbs@systemsbiology.org
# December 1, 2016

#################################################################################

# 1.  I searched hub.docker.com for 'bioconductor' to get some examples.

# 2. We can build off another defined file

# 3. I'm going to revise this docker file:
# https://github.com/NESCent/popgen-docker
# I'm going to edit that file, by:
# -- changing the Maintainer.
# -- remove the gsl install part.
# -- changes the R package installs
# -- adding my own package install from my github repo

# 4. Then I'm going to build the image
# https://docs.docker.com/engine/getstarted/step_four/
docker build -t gibbsdocker ~/Code/DockerExpr/

# this builds the image called gibbsdocker from the Dockerfile found in the
# Code/DockerExpr directory.

# 6. Make a repo, and push it to the docker repo.
docker tag dockerexpr gibbsdavidl/gibbsdocker:latest
docker images
docker login
docker push gibbsdavidl/gibbsdocker

# 7. Now I'm going to edit the example pipeline file
gsutil cp  gs://isb-cgc-open/compute/pipelines/samtools-pipeline.json  .
-- renamed to gibbsdocker-pipeline.json
-- changed 'name' to CatterPlots
-- added input for getting the script
-- changed the inputs and outputs


# Now we call the genomics pipeline to run it.

gcloud alpha genomics pipelines run \
--pipeline-file gibbsdocker-pipeline.yaml \
--inputs INPUT_FILE=gs://gibbs_bucket_nov162016/catter_input.txt \
--inputs INPUT_SCRIPT=gs://gibbs_bucket_nov162016/run_catterplots.R \
--outputs OUTPUT_FILE=gs://gibbs_bucket_nov162016/ \
--logging gs://gibbs_bucket_nov162016/logs/


# OK, it returns saying
Running [operations/ELO9_N2LKxir4eeR8czcOiDpiY-7hBQqD3Byb2R1Y3Rpb25RdWV1ZQ].

# We can check it's status with:
gcloud alpha genomics operations describe operations/ELO9_N2LKxir4eeR8czcOiDpiY-7hBQqD3Byb2R1Y3Rpb25RdWV1ZQ


#davidgibbs@pear ~/C/DockerExpr> gcloud alpha genomics operations describe operations/ELO9_N2LKxir4eeR8czcOiDpiY-7hBQqD3Byb2R1Y3Rpb25RdWV1ZQ
#done: false
#metadata:
#  '@type': type.googleapis.com/google.genomics.v1.OperationMetadata
#  clientId: ''
#  createTime: '2016-12-01T18:56:54Z'
#  events: []
#  labels: {}
#  projectId: isb-cgc-02-0001
#  request:
#    '@type': type.googleapis.com/google.genomics.v1alpha2.RunPipelineRequest
#    ephemeralPipeline:
#      description: Run a catter plots script to produce a figure
#      docker:
#        cmd: cd /mnt/data && Rscript run_catterplots.R
#        imageName: hub.docker.com/r/gibbsdavidl/gibbsdocker
#
#


# Now, we can check our bucket for the output.
